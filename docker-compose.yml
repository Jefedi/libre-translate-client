services:
  libretranslate:
    container_name: libretranslate
    image: libretranslate/libretranslate:latest
    ports:
      - 100.64.0.2:5000:5000
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - ./venv/bin/python scripts/healthcheck.py
      interval: 10s
      timeout: 4s
      retries: 4
      start_period: 5s
    tty: true
    environment:
      # === SÉCURITÉ API KEYS ===
      - LT_API_KEYS=true
      - LT_REQUIRE_API_KEY_SECRET=true
      # ⚠️ IMPORTANT : Change ce secret par un mot de passe fort !
      - LT_API_KEY_SECRET=ChangeThisToAStrongSecretKey123!
      - LT_API_KEYS_DB_PATH=/app/db/api_keys.db

      # === OPTIMISATION MODÈLES ===
      - LT_UPDATE_MODELS=true

      # === CONFIGURATION RÉSEAU ===
      - LT_HOST=0.0.0.0
      - LT_PORT=5000
      - LT_THREADS=8

      # === LIMITES (Protection contre abus) ===
      - LT_CHAR_LIMIT=50000          # Max 50k caractères par requête
      - LT_BATCH_LIMIT=100           # Max 100 textes en batch
      - LT_REQ_LIMIT=100             # 100 requêtes/min pour les IPs sans clé
      # Pas de limite quotidienne (usage privé)

      # === INTERFACE WEB ===
      - LT_DISABLE_WEB_UI=false
      - LT_FRONTEND_LANGUAGE_SOURCE=fr
      - LT_FRONTEND_LANGUAGE_TARGET=en

      # === FONCTIONNALITÉS ===
      - LT_DISABLE_FILES_TRANSLATION=false
      - LT_SUGGESTIONS=true          # Activer les suggestions

      # === PERFORMANCE ===
      - LT_LOAD_ONLY=                # Charge toutes les langues
      - LT_METRICS=true              # Activer les métriques

    volumes:
      - libretranslate_api_keys:/app/db
      - libretranslate_models:/home/libretranslate/.local:rw

    networks:
      - translate_network

  # API Gateway (optionnel - décommenter pour l'utiliser)
  # api_gateway:
  #   container_name: translate_api_gateway
  #   build: ./backend
  #   ports:
  #     - 100.64.0.2:3000:3000
  #   restart: unless-stopped
  #   environment:
  #     - LIBRETRANSLATE_URL=http://libretranslate:5000
  #     - NODE_ENV=production
  #     - PORT=3000
  #   volumes:
  #     - ./backend:/app
  #     - gateway_data:/app/data
  #   depends_on:
  #     - libretranslate
  #   networks:
  #     - translate_network

volumes:
  libretranslate_api_keys:
    driver: local
  libretranslate_models:
    driver: local
  # gateway_data:
  #   driver: local

networks:
  translate_network:
    driver: bridge
